# مشكلة: عدم تغيّر لغة "Book Information" عند تبديل "Select Language"

مستند فني لمطور لتنفيذ الإصلاح

## الملخص
- عند تغيير اللغة من قائمة "Select Language"، تتحدّث بطاقات "Processing Results" بشكل صحيح، بينما قسم "Book Information" لا يتغيّر كما هو متوقّع.
- الهدف: جعل "Book Information" يتبع نفس اللغة المختارة، مع آلية fallback ذكية ودعم موحّد لـ 16 لغة عبر التطبيق.

## السلوك الحالي
- "Processing Results" يعرض النتائج وفق اللغة المختارة لأن قيمة اللغة المرسلة/المحفوظة متوافقة مع ما يُعرض.
- "Book Information" يبقى ثابتاً غالباً على العربية/الإنجليزية ولا يعكس اختيار لغات أخرى مثل الفرنسية/الروسية.

## الأسباب المتوقعة
1) عدم توحيد تمثيل اللغة عبر الطبقات:
   - الواجهة تستخدم تسميات مختلفة (قد تكون أسماء محلية مثل Français/Русский أو رموز ISO مثل fr/ru).
   - قاعدة البيانات في books_info.language تعتمد غالباً "أسماء إنجليزية" (Arabic, English, French, Russian...).
   - في جزئية التحقق/الجلب، يتم أحياناً استخدام رموز الواجهة (ar/en) أو رفض لغات خارجها، مما يؤدي إلى سقوط غير مقصود للغة الافتراضية.

2) تضارب في مصادر أسماء اللغات:
   - بعض الدوال تستخدم رموز ISO (ar, en, fr...)، والبعض الآخر يستخدم أسماء إنجليزية، وأخرى قد تتعامل مع مسميات محلية؛ هذا يسبب فشل المطابقة في الاستعلامات.

3) بيانات غير موحّدة في قاعدة البيانات:
   - رُصدت حالة "الروسية" بجانب "Russian"؛ هذا يسبب فشل where(language=...) إذا أُرسلت قيمة غير متطابقة.

4) نقص تكامل الواجهة مع الخادم لقسم "Book Information":
   - قد لا يوجد endpoint مخصص يُرجع معلومات الكتاب بلغة معينة لتحديث القسم ديناميكياً عند تغيير الاختيار، أو لا يتم استدعاؤه من الواجهة.

## التأثير
- تجربة مستخدم مربكة: تبدّل نتائج المعالجة بينما لا تتبدّل معلومات الكتاب.
- احتمالية عرض بيانات خاطئة أو fallback غير مبرّر.
- صعوبة التوسّع المستقبلي للغات إضافية.

## المتطلبات
- دعم 16 لغة معروفة عبر التطبيق بشكل موحّد.
- تمثيل واحد للحفظ والاستعلام: English names للغات في قاعدة البيانات وحقل target_language في المخرجات.
- آلية fallback: 1) اللغة المطلوبة 2) اللغة المفضلة للمستخدم (Arabic/English) 3) أول سجل متاح.
- تحديث قسم "Book Information" ديناميكياً عند تغيير "Select Language".

## الحلول المقترحة

1) توحيد تمثيل اللغة Domain-wide
- اعتماد English names كقيمة قياسية للحفظ في قاعدة البيانات وفي target_language للمخرجات: 
  Arabic, English, French, Spanish, German, Italian, Portuguese, Russian, Chinese, Japanese, Korean, Turkish, Persian, Urdu, Hindi, Bengali.
- إنشاء دالة تطبيع واحدة تحوّل أي مدخل (ISO أو تسمية محلية) إلى English name قبل أي حفظ/استعلام.

2) فصل لغة الواجهة عن لغة بيانات الكتاب
- دوال لغة الواجهة (ar/en) لا تُستخدم للتحقق/التقييد في سياق بيانات الكتاب أو نتائج المعالجة.
- إنشاء دوال مخصّصة لسياق بيانات الكتاب:
  - normalizeBookInfoLanguage(input) → English name
  - isValidBookInfoLanguage(input) → ضمن 16 لغة
  - getPreferredBookInfoLanguage() → Arabic إذا كانت الواجهة ar، وإلا English (وكلاهما بصيغة English name)

3) توحيد مسارات الجلب والحفظ
- عند الحفظ (نتائج المعالجة/معلومات الكتاب):
  - طبّع اللغة أولاً، واحفظ English name فقط في كل الحقول المرتبطة باللغة.
- عند الجلب:
  - طبّع اللغة المطلوب عرضها، وابحث بالتسلسل: المطلوبة → المفضلة → أول متاح.
- تطبيق ذلك في نقاط المنطق الخاصة بـ Book Information والمخرجات.

4) تحديث الواجهة
- عند تغيير "Select Language"، استدعِ endpoint مخصص يعيد جزئية "Book Information" للغة المختارة، ويتم تحديث القسم عبر AJAX.
- قيمة select (value) يُفضّل أن تكون English name، ويمكن قبول ISO/محلي وسيتم تطبيعها في الخادم.

5) تنظيف قاعدة البيانات
- توحيد أي قيم غير مطابقة إلى English names.
- مثال مؤكد: تحديث "الروسية" إلى "Russian".
- التحقق المستمر من عدم وجود قيم خارج قائمة 16 لغة.

6) تحسينات اختيارية
- إضافة فهرس فريد (book_id, language) لمنع تكرار سجلات نفس اللغة لنفس الكتاب.
- كاش خفيف لقائمة bookInfos لكل كتاب لتقليل الاستعلامات عند تبديل اللغة سريعاً.

## خطة التنفيذ المختصرة
- إضافة دوال التطبيع/التحقق/التفضيل الخاصة ببيانات الكتاب.
- تعديل دوال الجلب لمعلومات الكتاب لتستخدم التطبيع والفول‌بك.
- تطبيع target_language قبل الحفظ في جميع أنواع المخرجات.
- إضافة endpoint يعيد جزئية "Book Information" حسب اللغة.
- تعديل الواجهة لتحديث القسم عند تغيير اللغة.
- توحيد بيانات الكتب في قاعدة البيانات (تحويل القيَم غير المعيارية).

## معايير القبول (Acceptance Criteria)
- عند اختيار French:
  - إذا توفّر سجل French في books_info: يُعرض.
  - إذا لم يتوفّر: fallback إلى Arabic إن كانت واجهة المستخدم ar، وإلا English.
  - إذا لم يتوفّر أي منهما: عرض أول سجل متاح.
- إدخال لغة بصيغة ISO (fr) أو محلية (Français) يعمل من دون مشاكل.
- "Processing Results" تستمر بالعمل وتتبع اللغة نفسها، وتُخزّن الأسماء الإنجليزية في target_language.
- لا توجد قيم لغات خارج قائمة 16 لغة في قاعدة البيانات بعد الإصلاح.

## المخاطر والحد من المخاطر
- خطر كسر توافق قديم إن كان اعتماد جزء آخر على رموز ISO: استعمال التطبيع يقلّص المخاطر.
- خطر بيانات تاريخية غير موحّدة: تنفيذ تسوية البيانات قبل النشر.
- خطر أداء عند تعدد النداءات: استخدام partial + AJAX وكاش خفيف يقلّل الحمل.

## خطة التراجع (Rollback)
- احتفظ بفرع Git منفصل؛ يمكن التراجع بالرجوع إلى الفرع السابق.
- احتفظ بنسخة احتياطية من قاعدة البيانات قبل التسوية؛ يمكن استرجاعها عند الحاجة.

## قائمة تحقق للمطور
- [ ] إضافة دوال تطبيع/تحقق/تفضيل للغات مجال الكتب (16 لغة).
- [ ] تعديل منطق الجلب لمعلومات الكتاب ليعتمد التطبيع والفول‌بك.
- [ ] تطبيع اللغة قبل الحفظ في كل المخرجات وBookInfo.
- [ ] إضافة endpoint لإرجاع جزئية "Book Information" حسب اللغة.
- [ ] ربط الواجهة لتحديث القسم عند تغيير اللغة.
- [ ] تسوية قاعدة البيانات (تحويل أي قيمة غير موحّدة إلى English names).
- [ ] اختبار الحالات: لغة متوفرة/غير متوفرة، ISO/محلي، fallback.
- [ ] إضافة فهرس فريد (book_id, language) اختيارياً.
